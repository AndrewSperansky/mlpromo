server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: /tmp/positions.yaml

clients:
  - url: http://promo_loki:3100/loki/api/v1/push

scrape_configs:

  # =========================
  # Backend (FastAPI / Uvicorn)
  # =========================
  - job_name: promo_ml_backend

    static_configs:
      - targets: [ localhost ]
        labels:
          job: promo_ml_backend
          service: backend
          __path__: /app/logs/app.log

    pipeline_stages:
      # –ü–∞—Ä—Å–∏–º JSON
      - json:
          expressions:
            levelname: levelname
            logger: name
            correlation_id: correlation_id
            src_file: filename
            src_line: lineno
            message: message

      # –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º —É—Ä–æ–≤–µ–Ω—å
      - template:
          source: levelname
          template: '{{ ToUpper .Value }}'

      # Labels ‚Äî –¢–û–õ–¨–ö–û —Å—Ç–∞–±–∏–ª—å–Ω—ã–µ
      - labels:
          levelname:
          logger:

      # correlation_id ‚Äî –ù–ï label (–∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–∞–∫ derived field)

      # –§–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç –ª–æ–≥–∞
      - output:
          source: message


  # =========================
  # NGINX access logs
  # =========================
  - job_name: nginx_access

    static_configs:
      - targets: [ localhost ]
        labels:
          job: nginx
          service: nginx
          __path__: /var/log/nginx/access.json

    pipeline_stages:
      # –ü–∞—Ä—Å–∏–º JSON access log
      - json:
          expressions:
            status: status
            method: method
            uri: uri
            request_time: request_time

      # Labels ‚Äî –º–∏–Ω–∏–º–∞–ª—å–Ω–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ
      - labels:
          status:
          method:

      # –û—Å—Ç–∞–≤–ª—è–µ–º URI –∫–∞–∫ —Ç–µ–ª–æ —Å–æ–æ–±—â–µ–Ω–∏—è
      - output:
          source: uri


  # =========================
  # PostgreSQL logs
  # =========================
  - job_name: postgres_logs
    static_configs:
      - targets: [ localhost ]
        labels:
          job: postgres
          service: postgres
          __path__: /var/log/postgresql/postgresql-*.log

    pipeline_stages:

      # –ü—Ä–∏–º–µ—Ä —Å—Ç—Ä–æ–∫–∏:
      # 2025-12-17 09:06:49.713 UTC [1] promo@promo LOG:  statement: SELECT ...

      - regex:
          expression: '^(?P<ts>\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}\.\d+ \w+) \[(?P<pid>\d+)\] (?:(?P<user>[\w-]+)@(?P<db>[\w-]+) )?(?P<level>\w+):\s+(?P<message>.*)$'
          # expression: '^(?P<ts>\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}\.\d+) \w+ \[\d+\] (?P<user>\w+)@(?P<db>\w+) (?P<level>[A-Z]+):\s+(?P<message>.*)$'

      - drop:
          source: message
          regex: 'checkpoint complete|listening on'

      - labels:
          level:
          user:
          db:

      - template:
          source: level
          template: '{{ ToUpper .Value }}'

      - timestamp:
          source: ts
          format: "2006-01-02 15:04:05.000"

      - output:
          source: message

  # =========================
  # REDIS logs
  # =========================

  - job_name: redis
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
        refresh_interval: 5s

    relabel_configs:
      # –ë–µ—Ä—ë–º –¢–û–õ–¨–ö–û –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä promo_redis
      - source_labels: [ __meta_docker_container_name ]
        regex: ^/promo_redis$
        action: keep

      # –ñ—ë—Å—Ç–∫–æ –∑–∞–¥–∞—ë–º labels
      - target_label: job
        replacement: redis
      - target_label: service
        replacement: redis
      - target_label: container_name
        replacement: promo_redis

    pipeline_stages:
      - docker: { }          # üëà –í–ê–ñ–ù–û: –≤–º–µ—Å—Ç–æ json
      - static_labels:
          job: redis
          service: redis
          container_name: promo_redis
      - labels:
          stream:
      - regex:
          expression: '^(?P<level>[\*#])\s+'
      - labels:
          level:

      - timestamp:
          source: time
          format: RFC3339Nano

